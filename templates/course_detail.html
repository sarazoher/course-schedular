{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

  <!-- Header: course title + back to plan + delete -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2>{{ course.code }} - {{ course.name }}</h2>
      <div class="text-muted">
        Plan:
        <a href="{{ url_for('main.view_plan', plan_id=plan.id) }}">
          {{ plan.name }}
        </a>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a href="{{ url_for('main.view_plan', plan_id=plan.id) }}"
         class="btn btn-outline-secondary">
        &larr; Back to plan
      </a>
      <form action="{{ url_for('main.delete_course',
                               plan_id=plan.id,
                               course_id=course.id) }}"
            method="POST"
            onsubmit="return confirm('Delete this course?');">
        <button type="submit" class="btn btn-outline-danger">
          Delete course
        </button>
      </form>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="courseTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active"
              id="details-tab"
              data-bs-toggle="tab"
              data-bs-target="#details"
              type="button"
              role="tab"
              aria-controls="details"
              aria-selected="true">
        Details
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              id="offerings-tab"
              data-bs-toggle="tab"
              data-bs-target="#offerings"
              type="button"
              role="tab"
              aria-controls="offerings"
              aria-selected="false">
        Offerings
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              id="prereq-tab"
              data-bs-toggle="tab"
              data-bs-target="#prereqs"
              type="button"
              role="tab"
              aria-controls="prereqs"
              aria-selected="false">
        Prerequisites
      </button>
    </li>
  </ul>

  <div class="tab-content pt-3" id="courseTabsContent">

    <!-- Details tab -->
    <div class="tab-pane fade show active"
         id="details"
         role="tabpanel"
         aria-labelledby="details-tab">
      <form action="{{ url_for('main.edit_course',
                               plan_id=plan.id,
                               course_id=course.id) }}"
            method="POST"
            class="mt-3">

        <div class="mb-3">
          <label class="form-label" for="code">Course code</label>
          <input type="text"
                 id="code"
                 name="code"
                 class="form-control"
                 value="{{ course.code }}"
                 required>
        </div>

        <div class="mb-3">
          <label class="form-label" for="name">Course name</label>
          <input type="text"
                 id="name"
                 name="name"
                 class="form-control"
                 value="{{ course.name }}"
                 required>
        </div>

        <div class="mb-3">
          <label class="form-label" for="credits">Credits</label>
          <input type="number"
                 id="credits"
                 name="credits"
                 class="form-control"
                 min="0"
                 value="{{ course.credits }}"
                 required>
        </div>

        <div class="mb-3">
          <label class="form-label" for="difficulty">Difficulty (optional)</label>
          <input type="number"
                 id="difficulty"
                 name="difficulty"
                 class="form-control"
                 min="1"
                 value="{{ course.difficulty or '' }}">
        </div>

        <button type="submit" class="btn btn-primary">
          Save details
        </button>
      </form>
    </div>

    <!-- Offerings tab -->
    <div class="tab-pane fade"
         id="offerings"
         role="tabpanel"
         aria-labelledby="offerings-tab">
      <form action="{{ url_for('main.edit_offerings',
                               plan_id=plan.id,
                               course_id=course.id) }}"
            method="POST"
            class="mt-3">

        <p>Select semesters where this course is offered:</p>

        <div class="d-flex flex-wrap gap-3">
          {% for s in range(1, total_semesters + 1) %}
          <div class="form-check me-3 mb-2">
            <input class="form-check-input"
                   type="checkbox"
                   name="semesters"
                   value="{{ s }}"
                   id="sem{{ s }}"
                   {% if s in selected_semesters %}checked{% endif %}>
            <label class="form-check-label" for="sem{{ s }}">
              Semester {{ s }}
            </label>
          </div>
          {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary mt-3">
          Save offerings
        </button>
      </form>
    </div>

    <!-- Prereqs tab -->
    <div class="tab-pane fade"
         id="prereqs"
         role="tabpanel"
         aria-labelledby="prereq-tab">
      <div class="mt-3 row">
        <!-- Incoming prereqs (what this course requires) -->
        <div class="col-md-6 mb-3">
          <h5>Requires these courses</h5>
          <ul class="list-unstyled">
            {% for edge in incoming_prereqs %}
              <li class="d-flex justify-content-between align-items-center mb-1">
                <span>
                  {{ edge.prereq_course.code }} â€“ {{ edge.prereq_course.name }}
                </span>
                <form method="POST"
                      action="{{ url_for('main.delete_prereq',
                                         plan_id=plan.id,
                                         course_id=course.id,
                                         prereq_id=edge.id) }}"
                      onsubmit="return confirm('Remove this prerequisite?');">
                  <button type="submit"
                          class="btn btn-sm btn-outline-danger">
                    Remove
                  </button>
                </form>
              </li>
            {% else %}
              <li class="text-muted">
                No prerequisites yet.
              </li>
            {% endfor %}
          </ul>

          <hr>

          <h6 class="mt-3">Add a prerequisite</h6>
          <form method="POST"
                action="{{ url_for('main.add_prereq',
                                   plan_id=plan.id,
                                   course_id=course.id) }}">
            <div class="mb-2">
              <select name="prereq_course_id"
                      class="form-select"
                      required>
                <option value="">-- Select course --</option>
                {% for c in available_prereq_courses %}
                  <option value="{{ c.id }}">
                    {{ c.code }} - {{ c.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="btn btn-sm btn-primary">
              Add prerequisite
            </button>
          </form>
        </div>

        <!-- Outgoing prereqs (where this course is required) -->
        <div class="col-md-6 mb-3">
          <h5>Is a prerequisite for</h5>
          <ul class="list-unstyled">
            {% for edge in outgoing_prereqs %}
              <li>
                {{ edge.course.code }} - {{ edge.course.name }}
              </li>
            {% else %}
              <li class="text-muted">
                Not required by any course yet.
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
