{% extends "base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-2">
  <h2 class="mb-0">Plan: "{{ plan.name }}"</h2>

  <div class="text-end">
    <a
      href="{{ url_for('main.dashboard') }}"
      class="btn btn-outline-secondary btn-sm me-2"
    >
      &larr; Back
    </a>

    <a
      href="{{ url_for('main.plan_settings', plan_id=plan.id) }}"
      class="btn btn-outline-secondary btn-sm me-2"
    >
      Plan settings
    </a>

    <form
      method="POST"
      action="{{ url_for('main.solve_plan', plan_id=plan.id) }}"
      class="d-inline"
    >
      <button type="submit" class="btn btn-primary btn-sm me-2">
        Solve plan
      </button>
    </form>

    {% if latest_solution %}
      <a
        href="{{ url_for('main.view_saved_schedule', plan_id=plan.id) }}"
        class="btn btn-outline-primary btn-sm me-2"
        title="Last saved: {{ latest_solution.created_at }}"
      >
        View latest schedule
      </a>
    {% endif %}

    <form method="POST"
          action="{{ url_for('main.delete_plan', plan_id=plan.id) }}"
          class="d-inline"
          onsubmit="return confirm('Delete this plan? This cannot be undone.');">
      <button type="submit" class="btn btn-outline-danger btn-sm">
        Delete Plan
      </button>
    </form>
  </div>
</div>

  {% if unlinked_count and unlinked_count > 0 %}
    <div class="alert alert-warning mt-3" role="alert">
      <strong>{{ unlinked_count }}</strong> course(s) were added from the catalog but are <strong>not linked</strong> to legacy Course row yet.
      The solver currently schedules only legacy courses,so these will be <strong>ignored</strong> until migration and linking is implemented. (wii be soon)
    </div>
  {% endif %}

  <h4 class="mt-4 mb-2">Courses in this plan</h4>

  {% if plan_courses %}
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Courses</span>
        <span class="badge bg-secondary">{{ plan_courses|length }}</span>
      </div>

      <ul class="list-group list-group-flush">
        {% for pc in plan_courses %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              {% if pc.legacy_course_id %}
                <a
                  href="{{ url_for('main.course_detail',
                                   plan_id=plan.id,
                                   course_id=pc.legacy_course_id) }}"
                  class="fw-semibold text-decoration-none"
                >
                  {{ pc.catalog_course.code }} — {{ pc.catalog_course.name }}
                </a>
                {% if optional_codes is defined and (pc.catalog_course.code|string) in optional_codes %}
                  <span class="badge bg-info text-dark ms-2">Optional</span>
                {% endif %}
              {% else %}
                <span class="fw-semibold">
                  {{ pc.catalog_course.code }} — {{ pc.catalog_course.name }}
                </span>
                {% if optional_codes is defined and (pc.catalog_course.code|string) in optional_codes %}
                  <span class="badge bg-info text-dark ms-2">Optional</span>
                {% endif %}
                <div class="small text-muted">
                  Details unavailable (legacy course not linked yet)
                </div>
              {% endif %}

              {% set m = catalog_meta_courses.get(pc.catalog_course.code|string) %}
              <div class="small text-muted">
                <div><strong>Credits:</strong> {{ pc.catalog_course.credits }}</div>

                {% if m %}
                  {% if m.academic_year %}<div><strong>Recommended year:</strong> {{ m.academic_year }}</div>{% endif %}
                  {% if m.weekly_hours %}<div><strong>Weekly hours:</strong> {{ m.weekly_hours }}</div>{% endif %}
                  {% if m.lecturer %}<div><strong>Lecturer:</strong> {{ m.lecturer }}</div>{% endif %}
                  {% if m.coreq_text %}<div><strong>Corequisites (info):</strong> {{ m.coreq_text }}</div>{% endif %}
                {% endif %}
              </div>
            </div>
            <div class="d-flex justify-content-end gap-2">
              {% if pc.legacy_course_id %}
                <a
                  href="{{ url_for('main.course_detail',
                                   plan_id=plan.id,
                                   course_id=pc.legacy_course_id) }}"
                  class="btn btn-outline-secondary btn-sm"
                >
                  Edit &amp; details
                </a>

                <form
                  method="POST"
                  action="{{ url_for('main.delete_course',
                                     plan_id=plan.id,
                                     course_id=pc.legacy_course_id) }}"
                  onsubmit="return confirm('Delete this course?');"
                >
                  <button type="submit" class="btn btn-outline-danger btn-sm">
                    Delete
                  </button>
                </form>
              {% else %}
                <button type="button" class="btn btn-outline-secondary btn-sm" disabled>
                  Not linked
                </button>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% else %}
    <p class="text-muted">No courses in this plan yet.</p>
  {% endif %}

  <div class="card mb-4">
    <div class="card-header">
      Bulk add from catalog
    </div>

    <div class="card-body">
      <form method="POST" action="{{ url_for('main.bulk_add_courses_v2', plan_id=plan.id) }}">
        <input type="hidden" name="degree" value="{{ selected_degree }}">

        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label" for="bulk_year">Recommended year (optional)</label>
            <select class="form-select" id="bulk_year" name="year">
              <option value="">All years</option>
              {% for y in available_years | default([]) %}
                <option value="{{ y }}">{{ y }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-9 mb-3 d-flex align-items-end gap-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="bulk_mandatory_only" name="mandatory_only" checked>
              <label class="form-check-label" for="bulk_mandatory_only">
                Mandatory only
              </label>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="bulk_include_optional" name="include_optional">
              <label class="form-check-label" for="bulk_include_optional">
                Include optional courses
              </label>
            </div>

            <button type="submit" class="btn btn-outline-success">
              Bulk add
            </button>
          </div>
        </div>

        <div class="small text-muted">
          Optional is inferred from course code: <code>850…</code> mandatory, <code>851…</code> optional; other degrees treated as optional by default.
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      Add a new course
    </div>

    <div class="card-body">
      <form
        method="POST"
        action="{{ url_for('main.add_course', plan_id=plan.id) }}"
      >
      <div class="mb-3">
        <label class="form-label" for="degree_filter">Degree</label>
        <select class="form-select" id="degree_filter">
          {% for key, info in degrees.items() %}
            <option value="{{ key }}" {% if key == selected_degree %}selected{% endif %}>
              {{ info.label if info.label else key }}
            </option>
          {% endfor %}
        </select>
        <div class="form-text">
          This filter affects the catalog dropdown only.
        </div>
      </div>

      <div class="mb-3">
        <label for="catalog_pick" class="form-label">Pick from catalog (optional)</label>
        <select class="form-select" id="catalog_pick" name="catalog_pick">
          <option value="">— Choose a canonical course —</option>
          {% for c in catalog_courses %}
            <option value="{{ c.code }}||{{ c.name }}||{{ c.credits }}">
              {{ c.code }} — {{ c.name }} ({{ c.credits }})
            </option>
          {% endfor %}
        </select>
        <div class="form-text">
          Selecting a catalog course will fill Code/Name/Credits below.
        </div>

        <div id="catalog_meta_preview" class="mt-2 small text-muted">
          Select a catalog course to see catalog metadata (recommended year, hours, lecturer, coreqs).
        </div>
      </div>
        <div class="row">
          <div class="col-md-3 mb-3">
            <label for="code" class="form-label">Code</label>
            <input
              type="text"
              class="form-control"
              id="code"
              name="code"
              required
            >
          </div>

          <div class="col-md-5 mb-3">
            <label for="name" class="form-label">Name</label>
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              required
            >
          </div>

          <div class="col-md-2 mb-3">
            <label for="credits" class="form-label">Credits</label>
            <input
              type="number"
              class="form-control"
              id="credits"
              name="credits"
              min="0"
              step="0.5"
              required
            >
          </div>

          <div class="col-md-2 mb-3">
            <label for="difficulty" class="form-label">
              Difficulty (optional)
            </label>
            <input
              type="number"
              class="form-control"
              id="difficulty"
              name="difficulty"
              min="1"
              max="5"
            >
          </div>
        </div>

        <button type="submit" class="btn btn-success">
          Add course
        </button>
      </form>
    </div>
  </div>
<script id="catalog-meta-json" type="application/json">
  {{ catalog_meta_courses | tojson }}
</script>

<script>
  (function () {
    const deg = document.getElementById("degree_filter");
    if (deg) {
      deg.addEventListener("change", function () {
        const url = new URL(window.location.href);
        url.searchParams.set("degree", this.value);
        window.location.href = url.toString();
      });
    }

    const sel = document.getElementById("catalog_pick");
    if (!sel) return;

    const metaEl = document.getElementById("catalog-meta-json");
    const metaCourses = metaEl ? JSON.parse(metaEl.textContent || "{}") : {};

    const preview = document.getElementById("catalog_meta_preview");

    function setPreviewFor(code) {
      if (!code) {
        if (preview) {
          preview.textContent =
            "Select a catalog course to see catalog metadata (recommended year, hours, lecturer, coreqs).";
        }
        return;
      }

      const m = metaCourses[String(code)] || {};
      const rows = [];

      if (m.academic_year) rows.push(`<div class="mb-1"><strong>Recommended year:</strong> ${m.academic_year}</div>`);
      if (m.weekly_hours) rows.push(`<div class="mb-1"><strong>Weekly hours:</strong> ${m.weekly_hours}</div>`);
      if (m.lesson_type) rows.push(`<div class="mb-1"><strong>Type:</strong> ${m.lesson_type}</div>`);
      if (m.lecturer) rows.push(`<div class="mb-1"><strong>Lecturer:</strong> ${m.lecturer}</div>`);
      if (m.coreq_text) rows.push(`<div class="mb-1"><strong>Corequisites (info):</strong> ${m.coreq_text}</div>`);

      if (!rows.length) {
        if (preview) preview.textContent = "No catalog metadata found for this course.";
        return;
      }

      if (preview) preview.innerHTML = rows.join("");
    }

    sel.addEventListener("change", function () {
      if (!this.value) {
        setPreviewFor(null);
        return;
      }

      const parts = this.value.split("||");
      if (parts.length !== 3) return;

      const [code, name, credits] = parts;

      const codeInput = document.getElementById("code");
      const nameInput = document.getElementById("name");
      const creditsInput = document.getElementById("credits");

      if (codeInput) codeInput.value = code;
      if (nameInput) nameInput.value = name;
      if (creditsInput) creditsInput.value = credits;

      setPreviewFor(code);
    });

    // initialize preview if something already selected
    // const initial = sel.value ? sel.value.split("||")[0] : null;
    // setPreviewFor(initial);
  })();
</script>

{% endblock %}