{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="mb-0">Schedule for "{{ plan.name }}"</h2>

    <div class="text-end">
      <a href="{{ url_for('main.view_plan', plan_id=plan.id) }}"
         class="btn btn-outline-secondary btn-sm me-2">
        &larr; Back to plan
      </a>

      <a href="{{ url_for('main.plan_settings', plan_id=plan.id) }}"
         class="btn btn-outline-secondary btn-sm me-2">
        Plan settings
      </a>

      <form method="POST"
            action="{{ url_for('main.solve_plan', plan_id=plan.id) }}"
            class="d-inline">
        <button type="submit" class="btn btn-primary btn-sm">
          Re-solve
        </button>
      </form>
    </div>
  </div>

  <p class="mb-3">
    Solver status:
    <span
      class="badge solver-status
         {% if status == 'Optimal' %}solver-ok
         {% elif status == 'Infeasible' %}solver-bad
         {% else %}solver-unknown{% endif %}"
    >
      {{ status }}
    </span>
  </p>

  {% set warnings_list = warnings | default([]) %}
  {% set meta = meta | default({}) %}

  {# Display-only mapping for reviewer-friendly warning text (no logic changes) #}
  {% set WARNING_LABELS = {
    "unresolved": "Unresolved prerequisite",
    "missing_course": "Missing prerequisite course",
    "external": "External requirement"
  } %}

  {% set WARNING_EXPLAINS = {
    "unresolved": "This prerequisite could not be fully resolved from catalog text. It was recorded but not enforced.",
    "missing_course": "The catalog references a prerequisite course code that is not currently included in this plan.",
    "external": "This course has a prerequisite outside the plan (e.g., service/external requirement)."
  } %}

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <!-- Upgraded warnings (count + affected courses + kind breakdown if provided) -->
      <div>
        <span>Warnings</span>

        {% if warnings_list and warnings_list|length %}
          <span class="badge bg-warning text-dark ms-2">{{ warnings_list|length }}</span>

          {% if warn_courses is defined %}
            <span class="text-muted small ms-2">({{ warn_courses|length }} courses)</span>
          {% endif %}
        {% else %}
          <span class="badge bg-secondary ms-2">0</span>
        {% endif %}
      </div>

      {% if warn_counts_by_kind is defined and warn_counts_by_kind %}
        <div class="small text-muted">
          {% for k, v in warn_counts_by_kind.items() %}
            {% set label = WARNING_LABELS.get(k, k|replace("_", " ")|title) %}
            <span class="ms-2">{{ label }}: {{ v }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="card-body small">
      {% if warnings_list %}
        <ul class="mb-0">
          {% for w in warnings_list %}
            <li class="mb-2">
              {% if w is mapping %}
                {% set course = w.get("course") or "?" %}
                {% set kind = w.get("kind") or w.get("type") or "" %}
                {% set raw = w.get("raw") %}
                {% set msg = w.get("message") or w.get("detail") %}
                {% set label = WARNING_LABELS.get(kind, kind|replace("_", " ")|title if kind else "") %}
                {% set explain = WARNING_EXPLAINS.get(kind) %}

                <div>
                  <strong>{{ course }}</strong>
                  {% if label %}
                    — <span class="text-muted">{{ label }}</span>
                  {% endif %}
                </div>

                {% if explain %}
                  <div class="text-muted">{{ explain }}</div>
                {% endif %}

                {% if raw %}
                  <div class="text-muted">
                    <code>{{ raw }}</code>
                  </div>
                {% elif msg %}
                  <div class="text-muted">
                    {{ msg }}
                  </div>
                {% endif %}
              {% else %}
                {{ w }}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-muted">No warnings.</div>
      {% endif %}
    </div>
  </div>


  {% set hints = infeasible_hints | default([]) %}

  {% if status != 'Optimal' %}
    <div class="alert alert-warning" role="alert">
      <div class="fw-semibold">No valid schedule could be produced.</div>
      <div class="mt-1">
        The solver could not find a feasible schedule under the current plan configuration.
        This usually happens when course availability, prerequisites, or plan limits conflict.
      </div>

      {% if hints %}
        <ul class="mt-2 mb-2">
          {% for h in hints %}
            <li>{{ h }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      <div class="mt-2">
        <div class="fw-semibold mb-1">What to try next</div>
        <ul class="mb-0">
          <li>
            Review <strong>Schedule → Warnings</strong> to see which prerequisites were recorded but not enforceable.
          </li>
          <li>
            Adjust credit limits, semester count, or other constraints in
            <a href="{{ url_for('main.plan_settings', plan_id=plan.id) }}">Plan settings</a>.
          </li>
          <li>
            If courses are restricted to specific semesters, verify their availability assumptions.
          </li>
        </ul>
      </div>
      <div class="text-muted mt-2">
        Infeasible plans do not indicate an error — they indicate that the current constraints cannot all be satisfied at once.
      </div>
    </div>
  {% else %}
    <div class="row">
      {% for sem in semesters %}
        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-header">
              {% if semester_labels is defined and sem in semester_labels %}
                {{ semester_labels[sem] }}
              {% else %}
                Semester {{ sem }}
              {% endif %}
            </div>
            
            <ul class="list-group list-group-flush">
              {% set bucket = courses_by_semester.get(sem, []) %}

              {% if bucket %}
                {% for course in bucket %}
                  {% set code_s = (course.code|string) %}
                  {% set m = (catalog_meta_courses.get(code_s) if catalog_meta_courses is defined else None) %}
                  <!-- meta debug: {{ m }} -->
                  <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="d-flex align-items-center gap-2">
                        <span
                          class="badge
                            {% if optional_codes is defined and code_s in optional_codes %}
                              bg-info-subtle text-dark border
                            {% else %}
                              bg-success-subtle text-dark border

                            {% endif %}
                          "
                          style="min-width: 2.5rem; text-align: center;"
                          title="Credits"
                        >
                          {{ course.credits | default('?') }}
                        </span>


                        <div>
                          <strong>{{ course.code | default('') }}</strong>
                          — {{ course.name | default('') }}
                        </div>

                        <!-- ⚠ marker if this course has warnings -->
                        {% set code_s = (course.code|string) %}
                        {% if warn_courses is defined and code_s in warn_courses %}
                          <span
                            class="badge bg-warning text-dark ms-2"
                            title="See Schedule → Warnings"
                          >⚠</span>
                        {% endif %}
                      </div>

                      <div class="d-flex gap-2">
                        {% if optional_codes is defined and code_s in optional_codes %}
                          <span class="badge bg-info text-dark">Optional</span>
                        {% endif %}
                      </div>
                    </div>

                    <div class="small text-muted mt-1">
                      {# <span><strong>Credits:</strong> {{ course.credits | default('') }}</span> #}

                      {% if m %}
                        {% if m.get("academic_year") %}<span class="ms-2">• <strong>Year:</strong> {{ m.get("academic_year") }}</span>{% endif %}
                        {% if m.get("weekly_hours") %}<span class="ms-2">• <strong>Hours:</strong> {{ m.get("weekly_hours") }}</span>{% endif %}
                        {% if m.get("lesson_type") %}<span class="ms-2">• <strong>Type:</strong> {{ m.get("lesson_type") }}</span>{% endif %}
                        {% if m.get("lecturer") %}<span class="ms-2">• <strong>Lecturer:</strong> {{ m.get("lecturer") }}</span>{% endif %}
                      {% endif %}
                    </div>

                    {% if m and m.get("prereq_text") %}
                      <div class="small text-muted mt-1">
                        <strong>Prereqs (catalog, info):</strong> {{ m.get("prereq_text") }}
                      </div>
                    {% endif %}

                    {% if m and m.get("coreq_text") %}
                      <div class="small text-muted mt-1">
                        <strong>Coreqs (catalog, info):</strong> {{ m.get("coreq_text") }}
                      </div>
                    {% endif %}

                    {# Keep backward compat if course.coreq_text exists in your schedule objects #}
                    {% if (not (m and m.get("coreq_text"))) and course.coreq_text %}
                      <div class="small text-muted mt-1">
                        <strong>Coreqs (info):</strong> {{ course.coreq_text }}
                      </div>
                    {% endif %}
                  </li>
                {% endfor %}
              {% else %}
                <li class="list-group-item text-muted">
                  No courses scheduled in this semester.
                </li>
              {% endif %}
            </ul>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}
