{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="mb-0">Schedule for "{{ plan.name }}"</h2>

    <div class="text-end">
      <a href="{{ url_for('main.view_plan', plan_id=plan.id) }}"
         class="btn btn-outline-secondary btn-sm me-2">
        &larr; Back to plan
      </a>

      <a href="{{ url_for('main.plan_settings', plan_id=plan.id) }}"
         class="btn btn-outline-secondary btn-sm me-2">
        Plan settings
      </a>

      <form method="POST"
            action="{{ url_for('main.solve_plan', plan_id=plan.id) }}"
            class="d-inline">
        <button type="submit" class="btn btn-primary btn-sm">
          Re-solve
        </button>
      </form>
    </div>
  </div>

  <p class="mb-3">
    Solver status:
    <span
      class="badge solver-status
         {% if status == 'Optimal' %}solver-ok
         {% elif status == 'Infeasible' %}solver-bad
         {% else %}solver-unknown{% endif %}"
    >
      {{ status }}
    </span>
  </p>

  {% set warnings_list = warnings | default([]) %}
  {% set meta = meta | default({}) %}

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <!-- Upgraded warnings (count + affected courses + kind breakdown if provided) -->
      <div>
        <span>Warnings</span>

        {% if warnings_list and warnings_list|length %}
          <span class="badge bg-warning text-dark ms-2">{{ warnings_list|length }}</span>

          {% if warn_courses is defined %}
            <span class="text-muted small ms-2">({{ warn_courses|length }} courses)</span>
          {% endif %}
        {% else %}
          <span class="badge bg-secondary ms-2">0</span>
        {% endif %}
      </div>

      {% if warn_counts_by_kind is defined and warn_counts_by_kind %}
        <div class="small text-muted">
          {% for k, v in warn_counts_by_kind.items() %}
            <span class="ms-2">{{ k }}: {{ v }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="card-body small">
      {% if warnings_list %}
        <ul class="mb-0">
          {% for w in warnings_list %}
            <li>
              {% if w is mapping %}
                <strong>{{ w.get("course") or "?" }}</strong>
                {% if w.get("kind") %}
                  — <span class="text-muted">{{ w.get("kind") }}</span>
                {% endif %}

                {% if w.get("raw") %}
                  <div class="text-muted">
                    <code>{{ w.get("raw") }}</code>
                  </div>
                {% elif w.get("message") or w.get("detail") %}
                  <div class="text-muted">
                    {{ w.get("message") or w.get("detail") }}
                  </div>
                {% endif %}
              {% else %}
                {{ w }}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-muted">No warnings.</div>
      {% endif %}
    </div>
  </div>

  {% set hints = infeasible_hints | default([]) %}

  {% if status != 'Optimal' %}
    <div class="alert alert-warning" role="alert">
      <div class="fw-semibold">No valid schedule could be produced.</div>
      <div class="mt-1">
        The solver couldn't find a feasible solution under your current offerings + settings.
      </div>

      {% if hints %}
        <ul class="mt-2 mb-2">
          {% for h in hints %}
            <li>{{ h }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      <div class="mt-2">
        <div class="fw-semibold mb-1">What to try next</div>
        <ul class="mb-0">
          <li>
            Review offerings and prerequisites in
            <a href="{{ url_for('main.view_plan', plan_id=plan.id) }}">the plan page</a>.
          </li>
          <li>
            Adjust total semesters / max credits / solver flags in
            <a href="{{ url_for('main.plan_settings', plan_id=plan.id) }}">Plan settings</a>.
          </li>
        </ul>
      </div>
    </div>
  {% else %}
    <div class="row">
      {% for sem in semesters %}
        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-header">
              {% if semester_labels is defined and sem in semester_labels %}
                {{ semester_labels[sem] }}
              {% else %}
                Semester {{ sem }}
              {% endif %}
            </div>
            <ul class="list-group list-group-flush">
              {% set bucket = courses_by_semester.get(sem, []) %}
              {% if bucket %}
                {% for course in bucket %}
                  <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <strong>{{ course.code | default('') }}</strong>
                        — {{ course.name | default('') }}

                        <!-- ⚠ marker if this course has warnings -->
                        {% set code_s = (course.code|string) %}
                        {% if warn_courses is defined and code_s in warn_courses %}
                          <span class="badge bg-warning text-dark ms-2" title="Has prerequisite/catalog warnings">⚠</span>
                        {% endif %}
                      </div>

                      {% if optional_codes is defined and (course.code|string) in optional_codes %}
                        <span class="badge bg-info text-dark">Optional</span>
                      {% endif %}
                    </div>

                    <small class="text-muted">
                      Credits: {{ course.credits | default('') }}
                    </small>

                    {% if course.coreq_text %}
                      <div class="small text-muted mt-1">
                        <strong>Coreq (info):</strong> {{ course.coreq_text }}
                      </div>
                    {% endif %}
                  </li>

                {% endfor %}
              {% else %}
                <li class="list-group-item text-muted">
                  No courses scheduled in this semester.
                </li>
              {% endif %}
            </ul>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}
